import { Observable } from 'rxjs';
import { share } from 'rxjs/operators';
import * as io from 'socket.io-client';
export class WrappedSocket {
    config;
    subscribersCounter = {};
    eventObservables$ = {};
    namespaces = {};
    ioSocket;
    emptyConfig = {
        url: '',
        options: {},
    };
    constructor(config) {
        this.config = config;
        if (config === undefined) {
            config = this.emptyConfig;
        }
        const url = config.url;
        const options = config.options;
        const ioFunc = io.default ? io.default : io;
        this.ioSocket = ioFunc(url, options);
    }
    /**
     * Gets a WrappedSocket for the given namespace.
     *
     * @note if an existing socket exists for the given namespace, it will be reused.
     *
     * @param namespace the namespace to create a new socket based on the current config.
     *        If empty or `/`, then the current instance is returned.
     * @returns a socket that is bound to the given namespace. If namespace is empty or `/`,
     *          then `this` is returned, otherwise another instance is returned, creating
     *          it if it's the first use of such namespace.
     */
    of(namespace) {
        if (!namespace || namespace === '/') {
            return this;
        }
        const existing = this.namespaces[namespace];
        if (existing) {
            return existing;
        }
        const { url, ...rest } = this.config;
        const config = {
            url: !url.endsWith('/') && !namespace.startsWith('/')
                ? `${url}/${namespace}`
                : `${url}${namespace}`,
            ...rest,
        };
        const created = new WrappedSocket(config);
        this.namespaces[namespace] = created;
        return created;
    }
    on(eventName, callback) {
        this.ioSocket.on(eventName, callback);
        return this;
    }
    once(eventName, callback) {
        this.ioSocket.once(eventName, callback);
        return this;
    }
    connect() {
        this.ioSocket.connect();
        return this;
    }
    disconnect() {
        this.ioSocket.disconnect();
        return this;
    }
    emit(_eventName, ..._args) {
        this.ioSocket.emit.apply(this.ioSocket, arguments);
        return this;
    }
    send(..._args) {
        this.ioSocket.send.apply(this.ioSocket, arguments);
        return this;
    }
    emitWithAck(_eventName, ..._args) {
        return this.ioSocket.emitWithAck.apply(this.ioSocket, arguments);
    }
    removeListener(_eventName, _callback) {
        this.ioSocket.removeListener.apply(this.ioSocket, arguments);
        return this;
    }
    removeAllListeners(_eventName) {
        this.ioSocket.removeAllListeners.apply(this.ioSocket, arguments);
        return this;
    }
    fromEvent(eventName) {
        if (!this.subscribersCounter[eventName]) {
            this.subscribersCounter[eventName] = 0;
        }
        this.subscribersCounter[eventName]++;
        if (!this.eventObservables$[eventName]) {
            this.eventObservables$[eventName] = new Observable((observer) => {
                const listener = (data) => {
                    observer.next(data);
                };
                this.ioSocket.on(eventName, listener);
                return () => {
                    this.subscribersCounter[eventName]--;
                    if (this.subscribersCounter[eventName] === 0) {
                        this.ioSocket.removeListener(eventName, listener);
                        delete this.eventObservables$[eventName];
                    }
                };
            }).pipe(share());
        }
        return this.eventObservables$[eventName];
    }
    fromOneTimeEvent(eventName) {
        return new Promise(resolve => this.once(eventName, resolve));
    }
    listeners(eventName) {
        return this.ioSocket.listeners(eventName);
    }
    listenersAny() {
        return this.ioSocket.listenersAny();
    }
    listenersAnyOutgoing() {
        return this.ioSocket.listenersAnyOutgoing();
    }
    off(eventName, listener) {
        if (!eventName) {
            // Remove all listeners for all events
            this.ioSocket.offAny();
            return this;
        }
        if (eventName && !listener) {
            // Remove all listeners for that event
            this.ioSocket.off(eventName);
            return this;
        }
        // Removes the specified listener from the listener array for the event named
        this.ioSocket.off(eventName, listener);
        return this;
    }
    offAny(callback) {
        this.ioSocket.offAny(callback);
        return this;
    }
    offAnyOutgoing(callback) {
        this.ioSocket.offAnyOutgoing(callback);
        return this;
    }
    onAny(callback) {
        this.ioSocket.onAny(callback);
        return this;
    }
    onAnyOutgoing(callback) {
        this.ioSocket.onAnyOutgoing(callback);
        return this;
    }
    prependAny(callback) {
        this.ioSocket.prependAny(callback);
        return this;
    }
    prependAnyOutgoing(callback) {
        this.ioSocket.prependAnyOutgoing(callback);
        return this;
    }
    timeout(value) {
        this.ioSocket.timeout(value);
        return this;
    }
    get volatile() {
        // this getter has a side-effect of turning the socket instance true,
        // but it returns the actual instance, so we need to get the value to force the side effect
        const _ = this.ioSocket.volatile;
        return this;
    }
    get active() {
        return this.ioSocket.active;
    }
    get connected() {
        return this.ioSocket.connected;
    }
    get disconnected() {
        return this.ioSocket.disconnected;
    }
    get recovered() {
        return this.ioSocket.recovered;
    }
    get id() {
        return this.ioSocket.id;
    }
    compress(value) {
        this.ioSocket.compress(value);
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LWlvLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc29ja2V0LWlvLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkMsT0FBTyxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUl2QyxNQUFNLE9BQU8sYUFBYTtJQVVKO0lBVHBCLGtCQUFrQixHQUEyQixFQUFFLENBQUM7SUFDaEQsaUJBQWlCLEdBQW9DLEVBQUUsQ0FBQztJQUN4RCxVQUFVLEdBQWtDLEVBQUUsQ0FBQztJQUMvQyxRQUFRLENBQU07SUFDZCxXQUFXLEdBQW1CO1FBQzVCLEdBQUcsRUFBRSxFQUFFO1FBQ1AsT0FBTyxFQUFFLEVBQUU7S0FDWixDQUFDO0lBRUYsWUFBb0IsTUFBc0I7UUFBdEIsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFDeEMsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDekIsTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDNUIsQ0FBQztRQUNELE1BQU0sR0FBRyxHQUFXLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFDL0IsTUFBTSxPQUFPLEdBQVEsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLE1BQU0sR0FBSSxFQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBRSxFQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDOUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0gsRUFBRSxDQUFDLFNBQWlCO1FBQ2xCLElBQUksQ0FBQyxTQUFTLElBQUksU0FBUyxLQUFLLEdBQUcsRUFB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QixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNoYXJlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgKiBhcyBpbyBmcm9tICdzb2NrZXQuaW8tY2xpZW50JztcblxuaW1wb3J0IHsgU29ja2V0SW9Db25maWcgfSBmcm9tICcuL2NvbmZpZy9zb2NrZXQtaW8uY29uZmlnJztcblxuZXhwb3J0IGNsYXNzIFdyYXBwZWRTb2NrZXQge1xuICBzdWJzY3JpYmVyc0NvdW50ZXI6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcbiAgZXZlbnRPYnNlcnZhYmxlcyQ6IFJlY29yZDxzdHJpbmcsIE9ic2VydmFibGU8YW55Pj4gPSB7fTtcbiAgbmFtZXNwYWNlczogUmVjb3JkPHN0cmluZywgV3JhcHBlZFNvY2tldD4gPSB7fTtcbiAgaW9Tb2NrZXQ6IGFueTtcbiAgZW1wdHlDb25maWc6IFNvY2tldElvQ29uZmlnID0ge1xuICAgIHVybDogJycsXG4gICAgb3B0aW9uczoge30sXG4gIH07XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb25maWc6IFNvY2tldElvQ29uZmlnKSB7XG4gICAgaWYgKGNvbmZpZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25maWcgPSB0aGlzLmVtcHR5Q29uZmlnO1xuICAgIH1cbiAgICBjb25zdCB1cmw6IHN0cmluZyA9IGNvbmZpZy51cmw7XG4gICAgY29uc3Qgb3B0aW9uczogYW55ID0gY29uZmlnLm9wdGlvbnM7XG4gICAgY29uc3QgaW9GdW5jID0gKGlvIGFzIGFueSkuZGVmYXVsdCA/IChpbyBhcyBhbnkpLmRlZmF1bHQgOiBpbztcbiAgICB0aGlzLmlvU29ja2V0ID0gaW9GdW5jKHVybCwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhIFdyYXBwZWRTb2NrZXQgZm9yIHRoZSBnaXZlbiBuYW1lc3BhY2UuXG4gICAqXG4gICAqIEBub3RlIGlmIGFuIGV4aXN0aW5nIHNvY2tldCBleGlzdHMgZm9yIHRoZSBnaXZlbiBuYW1lc3BhY2UsIGl0IHdpbGwgYmUgcmV1c2VkLlxuICAgKlxuICAgKiBAcGFyYW0gbmFtZXNwYWNlIHRoZSBuYW1lc3BhY2UgdG8gY3JlYXRlIGEgbmV3IHNvY2tldCBiYXNlZCBvbiB0aGUgY3VycmVudCBjb25maWcuXG4gICAqICAgICAgICBJZiBlbXB0eSBvciBgL2AsIHRoZW4gdGhlIGN1cnJlbnQgaW5zdGFuY2UgaXMgcmV0dXJuZWQuXG4gICAqIEByZXR1cm5zIGEgc29ja2V0IHRoYXQgaXMgYm91bmQgdG8gdGhlIGdpdmVuIG5hbWVzcGFjZS4gSWYgbmFtZXNwYWNlIGlzIGVtcHR5IG9yIGAvYCxcbiAgICogICAgICAgICAgdGhlbiBgdGhpc2AgaXMgcmV0dXJuZWQsIG90aGVyd2lzZSBhbm90aGVyIGluc3RhbmNlIGlzIHJldHVybmVkLCBjcmVhdGluZ1xuICAgKiAgICAgICAgICBpdCBpZiBpdCdzIHRoZSBmaXJzdCB1c2Ugb2Ygc3VjaCBuYW1lc3BhY2UuXG4gICAqL1xuICBvZihuYW1lc3BhY2U6IHN0cmluZyk6IFdyYXBwZWRTb2NrZXQge1xuICAgIGlmICghbmFtZXNwYWNlIHx8IG5hbWVzcGFjZSA9PT0gJy8nKSB7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLm5hbWVzcGFjZXNbbmFtZXNwYWNlXTtcbiAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgIHJldHVybiBleGlzdGluZztcbiAgICB9XG4gICAgY29uc3QgeyB1cmwsIC4uLnJlc3QgfSA9IHRoaXMuY29uZmlnO1xuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgIHVybDpcbiAgICAgICAgIXVybC5lbmRzV2l0aCgnLycpICYmICFuYW1lc3BhY2Uuc3RhcnRzV2l0aCgnLycpXG4gICAgICAgICAgPyBgJHt1cmx9LyR7bmFtZXNwYWNlfWBcbiAgICAgICAgICA6IGAke3VybH0ke25hbWVzcGFjZX1gLFxuICAgICAgLi4ucmVzdCxcbiAgICB9O1xuICAgIGNvbnN0IGNyZWF0ZWQgPSBuZXcgV3JhcHBlZFNvY2tldChjb25maWcpO1xuICAgIHRoaXMubmFtZXNwYWNlc1tuYW1lc3BhY2VdID0gY3JlYXRlZDtcbiAgICByZXR1cm4gY3JlYXRlZDtcbiAgfVxuXG4gIG9uKGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogRnVuY3Rpb24pOiB0aGlzIHtcbiAgICB0aGlzLmlvU29ja2V0Lm9uKGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgb25jZShldmVudE5hbWU6IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5vbmNlKGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgY29ubmVjdCgpOiB0aGlzIHtcbiAgICB0aGlzLmlvU29ja2V0LmNvbm5lY3QoKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGRpc2Nvbm5lY3QoKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5kaXNjb25uZWN0KCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBlbWl0KF9ldmVudE5hbWU6IHN0cmluZywgLi4uX2FyZ3M6IGFueVtdKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5lbWl0LmFwcGx5KHRoaXMuaW9Tb2NrZXQsIGFyZ3VtZW50cyk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZW5kKC4uLl9hcmdzOiBhbnlbXSk6IHRoaXMge1xuICAgIHRoaXMuaW9Tb2NrZXQuc2VuZC5hcHBseSh0aGlzLmlvU29ja2V0LCBhcmd1bWVudHMpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZW1pdFdpdGhBY2s8VD4oX2V2ZW50TmFtZTogc3RyaW5nLCAuLi5fYXJnczogYW55W10pOiBQcm9taXNlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5pb1NvY2tldC5lbWl0V2l0aEFjay5hcHBseSh0aGlzLmlvU29ja2V0LCBhcmd1bWVudHMpO1xuICB9XG5cbiAgcmVtb3ZlTGlzdGVuZXIoX2V2ZW50TmFtZTogc3RyaW5nLCBfY2FsbGJhY2s/OiBGdW5jdGlvbik6IHRoaXMge1xuICAgIHRoaXMuaW9Tb2NrZXQucmVtb3ZlTGlzdGVuZXIuYXBwbHkodGhpcy5pb1NvY2tldCwgYXJndW1lbnRzKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHJlbW92ZUFsbExpc3RlbmVycyhfZXZlbnROYW1lPzogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5yZW1vdmVBbGxMaXN0ZW5lcnMuYXBwbHkodGhpcy5pb1NvY2tldCwgYXJndW1lbnRzKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGZyb21FdmVudDxUPihldmVudE5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8VD4ge1xuICAgIGlmICghdGhpcy5zdWJzY3JpYmVyc0NvdW50ZXJbZXZlbnROYW1lXSkge1xuICAgICAgdGhpcy5zdWJzY3JpYmVyc0NvdW50ZXJbZXZlbnROYW1lXSA9IDA7XG4gICAgfVxuICAgIHRoaXMuc3Vic2NyaWJlcnNDb3VudGVyW2V2ZW50TmFtZV0rKztcblxuICAgIGlmICghdGhpcy5ldmVudE9ic2VydmFibGVzJFtldmVudE5hbWVdKSB7XG4gICAgICB0aGlzLmV2ZW50T2JzZXJ2YWJsZXMkW2V2ZW50TmFtZV0gPSBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBsaXN0ZW5lciA9IChkYXRhOiBUKSA9PiB7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChkYXRhKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5pb1NvY2tldC5vbihldmVudE5hbWUsIGxpc3RlbmVyKTtcbiAgICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgICB0aGlzLnN1YnNjcmliZXJzQ291bnRlcltldmVudE5hbWVdLS07XG4gICAgICAgICAgaWYgKHRoaXMuc3Vic2NyaWJlcnNDb3VudGVyW2V2ZW50TmFtZV0gPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuaW9Tb2NrZXQucmVtb3ZlTGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lcik7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5ldmVudE9ic2VydmFibGVzJFtldmVudE5hbWVdO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgIH0pLnBpcGUoc2hhcmUoKSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmV2ZW50T2JzZXJ2YWJsZXMkW2V2ZW50TmFtZV07XG4gIH1cblxuICBmcm9tT25lVGltZUV2ZW50PFQ+KGV2ZW50TmFtZTogc3RyaW5nKTogUHJvbWlzZTxUPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFQ+KHJlc29sdmUgPT4gdGhpcy5vbmNlKGV2ZW50TmFtZSwgcmVzb2x2ZSkpO1xuICB9XG5cbiAgbGlzdGVuZXJzKGV2ZW50TmFtZTogc3RyaW5nKTogRnVuY3Rpb25bXSB7XG4gICAgcmV0dXJuIHRoaXMuaW9Tb2NrZXQubGlzdGVuZXJzKGV2ZW50TmFtZSk7XG4gIH1cblxuICBsaXN0ZW5lcnNBbnkoKTogRnVuY3Rpb25bXSB7XG4gICAgcmV0dXJuIHRoaXMuaW9Tb2NrZXQubGlzdGVuZXJzQW55KCk7XG4gIH1cblxuICBsaXN0ZW5lcnNBbnlPdXRnb2luZygpOiBGdW5jdGlvbltdIHtcbiAgICByZXR1cm4gdGhpcy5pb1NvY2tldC5saXN0ZW5lcnNBbnlPdXRnb2luZygpO1xuICB9XG5cbiAgb2ZmKGV2ZW50TmFtZT86IHN0cmluZywgbGlzdGVuZXI/OiBGdW5jdGlvbltdKTogdGhpcyB7XG4gICAgaWYgKCFldmVudE5hbWUpIHtcbiAgICAgIC8vIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGZvciBhbGwgZXZlbnRzXG4gICAgICB0aGlzLmlvU29ja2V0Lm9mZkFueSgpO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgaWYgKGV2ZW50TmFtZSAmJiAhbGlzdGVuZXIpIHtcbiAgICAgIC8vIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGZvciB0aGF0IGV2ZW50XG4gICAgICB0aGlzLmlvU29ja2V0Lm9mZihldmVudE5hbWUpO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlcyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyIGZyb20gdGhlIGxpc3RlbmVyIGFycmF5IGZvciB0aGUgZXZlbnQgbmFtZWRcbiAgICB0aGlzLmlvU29ja2V0Lm9mZihldmVudE5hbWUsIGxpc3RlbmVyKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIG9mZkFueShjYWxsYmFjaz86IChldmVudDogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IHRoaXMge1xuICAgIHRoaXMuaW9Tb2NrZXQub2ZmQW55KGNhbGxiYWNrKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIG9mZkFueU91dGdvaW5nKGNhbGxiYWNrPzogKGV2ZW50OiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5vZmZBbnlPdXRnb2luZyhjYWxsYmFjayk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBvbkFueShjYWxsYmFjazogKGV2ZW50OiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5vbkFueShjYWxsYmFjayk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBvbkFueU91dGdvaW5nKGNhbGxiYWNrOiAoZXZlbnQ6IHN0cmluZywgLi4uYXJnczogYW55W10pID0+IHZvaWQpOiB0aGlzIHtcbiAgICB0aGlzLmlvU29ja2V0Lm9uQW55T3V0Z29pbmcoY2FsbGJhY2spO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHJlcGVuZEFueShjYWxsYmFjazogKGV2ZW50OiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5wcmVwZW5kQW55KGNhbGxiYWNrKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHByZXBlbmRBbnlPdXRnb2luZyhcbiAgICBjYWxsYmFjazogKGV2ZW50OiBzdHJpbmcgfCBzeW1ib2wsIC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkXG4gICk6IHRoaXMge1xuICAgIHRoaXMuaW9Tb2NrZXQucHJlcGVuZEFueU91dGdvaW5nKGNhbGxiYWNrKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHRpbWVvdXQodmFsdWU6IG51bWJlcik6IHRoaXMge1xuICAgIHRoaXMuaW9Tb2NrZXQudGltZW91dCh2YWx1ZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBnZXQgdm9sYXRpbGUoKTogdGhpcyB7XG4gICAgLy8gdGhpcyBnZXR0ZXIgaGFzIGEgc2lkZS1lZmZlY3Qgb2YgdHVybmluZyB0aGUgc29ja2V0IGluc3RhbmNlIHRydWUsXG4gICAgLy8gYnV0IGl0IHJldHVybnMgdGhlIGFjdHVhbCBpbnN0YW5jZSwgc28gd2UgbmVlZCB0byBnZXQgdGhlIHZhbHVlIHRvIGZvcmNlIHRoZSBzaWRlIGVmZmVjdFxuICAgIGNvbnN0IF8gPSB0aGlzLmlvU29ja2V0LnZvbGF0aWxlO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZ2V0IGFjdGl2ZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pb1NvY2tldC5hY3RpdmU7XG4gIH1cblxuICBnZXQgY29ubmVjdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlvU29ja2V0LmNvbm5lY3RlZDtcbiAgfVxuXG4gIGdldCBkaXNjb25uZWN0ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaW9Tb2NrZXQuZGlzY29ubmVjdGVkO1xuICB9XG5cbiAgZ2V0IHJlY292ZXJlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pb1NvY2tldC5yZWNvdmVyZWQ7XG4gIH1cblxuICBnZXQgaWQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5pb1NvY2tldC5pZDtcbiAgfVxuXG4gIGNvbXByZXNzKHZhbHVlOiBib29sZWFuKTogdGhpcyB7XG4gICAgdGhpcy5pb1NvY2tldC5jb21wcmVzcyh2YWx1ZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbn1cbiJdfQ==